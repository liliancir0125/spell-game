<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è€³ç‹—è½å¯«æ¨‚åœ’ - Cinnamoroll Edition</title>
    <style>
        /* ------------------- CSS æ¨£å¼ ------------------- */
        body {
            font-family: 'Arial', sans-serif;
            /* 1. ã€èƒŒæ™¯åœ–ã€‘ä½¿ç”¨å¤–éƒ¨åœ–ç‰‡é€£çµä½œç‚ºèƒŒæ™¯ */
            background-image: url('https://i.imgur.com/KxX9I8I.png'); /* æ·ºè—è‰²é›²æœµå¤©ç©ºåœ– */
            background-size: cover; /* è¦†è“‹æ•´å€‹é é¢ */
            background-attachment: fixed; /* èƒŒæ™¯ä¸éš¨æ²å‹•è»¸ç§»å‹• */
            background-color: #e9f7ff; /* ä½œç‚ºåœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚çš„å¾Œå‚™é¡è‰² */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
            color: #333;
        }

        #game-container {
            width: 90%;
            max-width: 650px;
            /* æ·ºè—è‰²é‚Šæ¡†ï¼Œå¢åŠ å¯æ„›æ„Ÿ */
            border: 5px solid #a4e2ff; 
            /* å°‡å®¹å™¨è¨­ç‚ºåŠé€æ˜ç™½è‰²ï¼Œè®“èƒŒæ™¯åœ–é€å‡ºä¾† */
            background-color: rgba(255, 255, 255, 0.9); 
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            text-align: center;
        }

        /* é¸æ“‡ä»‹é¢ */
        #selection-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #grade-buttons-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        #unit-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            min-height: 50px;
        }

        /* çµ±ä¸€çš„æŒ‰éˆ•æ¨£å¼ */
        .unit-btn {
            padding: 8px 15px;
            font-size: 16px;
            /* ç²‰è‰²é‚Šæ¡† */
            border: 2px solid #ffb3c1; 
            border-radius: 8px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: all 0.1s;
        }
        
        .grade-btn { 
            padding: 10px 25px;
            font-size: 18px;
            font-weight: bold;
        }

        .unit-btn.selected {
            /* ä¸»é¡Œè—è‰² */
            background-color: #4a90e2; 
            color: white;
            border-color: #4a90e2;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* éŠæˆ²ç‹€æ…‹é¡¯ç¤º */
        #review-status {
            font-size: 18px;
            color: #d9534f;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        #hint-display {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 20px;
            min-height: 30px;
        }

        #input-area {
            display: flex;
            justify-content: center;
            gap: 8px; /* å­—å…ƒé–“éš” */
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .letter-slot {
            width: 45px;
            height: 55px;
            line-height: 55px;
            font-size: 32px;
            font-weight: bold;
            border: 3px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
        }

        /* è™›æ“¬ç©ºæ ¼æ§½ï¼Œè™•ç†çµ„åˆå–®å­—é–“çš„é–“éš” */
        .space-slot {
            width: 20px; 
            height: 55px;
            background-color: transparent;
            border: none;
        }

        /* éµç›¤èˆ‡æ§åˆ¶æŒ‰éˆ• */
        #keyboard {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .key {
            /* ã€å¤§è€³ç‹—é¢¨æ ¼ã€‘éµç›¤è‰²ï¼šæ·ºå¤©ç©ºè— */
            background-color: #a4e2ff; 
            color: #333; /* è®“å­—é«”æ›´æ¸…æ¥š */
            border: none;
            padding: 12px 0;
            font-size: 22px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .key:active {
            background-color: #79c5f0; /* æŒ‰ä¸‹æ™‚æ›´æ·±ä¸€é» */
        }
        
        /* DELETE éµ */
        #delete-key {
            background-color: #777;
            color: white;
            font-size: 18px;
        }

        #delete-key:active {
            background-color: #555;
        }


        #control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px #999;
            transition: all 0.1s;
        }

        .control-btn:active {
            box-shadow: 0 0 #999;
            transform: translateY(4px);
        }

        #repeat-btn {
            background-color: #5cb85c;
            color: white;
        }

        #check-btn {
            background-color: #f0ad4e;
            color: white;
        }
        
        #answer-btn {
            background-color: #5bc0de;
            color: white;
        }

        /* åé¥‹æ•ˆæœ */
        .correct {
            background-color: #aaffaa !important;
            border-color: #4CAF50 !important;
        }

        .incorrect {
            background-color: #ffaaaa !important;
            border-color: #f44336 !important;
        }

        .skipped {
            background-color: #ffe4b2 !important; 
            border-color: #ff8c00 !important;
        }

        #feedback-message {
            font-size: 28px;
            font-weight: bold;
            min-height: 30px;
            margin-top: 15px;
            color: #4a90e2;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <h2>â˜ï¸ å¤§è€³ç‹—è½å¯«æ¨‚åœ’ ğŸ©·</h2>
        
        <div id="review-status"></div>

        <div id="selection-controls">
            <div id="grade-buttons-container">
                <button class="grade-btn unit-btn" data-grade="G1" onclick="selectGrade(this)">G1</button>
                <button class="grade-btn unit-btn" data-grade="G2" onclick="selectGrade(this)">G2</button>
            </div>

            <div id="unit-buttons-container">
                è«‹å…ˆé¸æ“‡å¹´ç´š
            </div>
        </div>

        <div id="hint-display">è«‹å…ˆé¸æ“‡å¹´ç´šå’Œå–®å…ƒæŒ‰éˆ•ï¼Œç„¶å¾Œé»æ“Šé–‹å§‹ï¼</div>
        
        <div id="input-area"></div>

        <div id="control-buttons">
            <button id="start-btn" class="control-btn" onclick="startGame()" disabled>é–‹å§‹éŠæˆ² / ä¸‹ä¸€å€‹</button>
            <button id="repeat-btn" class="control-btn" disabled>ğŸ”ˆ é‡è¤‡å”¸ä¸€æ¬¡</button>
            <button id="check-btn" class="control-btn" disabled>âœ… æª¢æŸ¥æ‹¼å¯«</button>
            <button id="answer-btn" class="control-btn" onclick="showAnswer()" disabled>ğŸ“– çœ‹è§£ç­”</button>
        </div>

        <div id="feedback-message"></div>

        <div id="keyboard"></div>
    </div>

    <script>
        // ------------------- JavaScript é‚è¼¯ -------------------

        // 2. ã€ä¿®å¾© Bugã€‘ç§»é™¤æç¤ºä¸­çš„è‹±æ–‡å°å¯«ç­”æ¡ˆ
        const allWordUnits = {
            "G1": {
                "U1": [{ word: "HE IS", hint: "ä»–æ˜¯/å¥¹å€‘æ˜¯" }, { word: "I AM", hint: "æˆ‘æ˜¯" }, { word: "NAME", hint: "åå­—" }, { word: "SHE IS", hint: "å¥¹æ˜¯" }, { word: "THE", hint: "é€™å€‹/é‚£å€‹" }, { word: "THIS", hint: "é€™å€‹" }, { word: "YOU ARE", hint: "ä½ æ˜¯/æ‚¨æ˜¯" }, { word: "WHAT", hint: "ä»€éº¼" }],
                "U2": [{ word: "THAT", hint: "é‚£å€‹" }, { word: "AND", hint: "å’Œ" }, { word: "OUR", hint: "æˆ‘å€‘çš„" }, { word: "HER", hint: "å¥¹çš„" }, { word: "HIS", hint: "ä»–çš„" }, { word: "MY", hint: "æˆ‘çš„" }, { word: "OPEN", hint: "æ‰“é–‹" }, { word: "YOUR", hint: "ä½ çš„" }, { word: "THEY", hint: "ä»–å€‘/å¥¹å€‘" }, { word: "CLOSE", hint: "é—œé–‰" }, { word: "WE", hint: "æˆ‘å€‘" }, { word: "THEIR", hint: "ä»–å€‘çš„" }],
                "U3": [{ word: "SCHOOL", hint: "å­¸æ ¡" }, { word: "GOOD", hint: "å¥½çš„/æ£’çš„" }, { word: "GRADE", hint: "å¹´ç´š/åˆ†æ•¸" }, { word: "HELLO", hint: "ä½ å¥½" }, { word: "IN", hint: "åœ¨...è£¡é¢" }, { word: "NO", hint: "ä¸" }, { word: "NOT", hint: "ä¸" }, { word: "FIRST", hint: "ç¬¬ä¸€" }, { word: "TOO", hint: "ä¹Ÿ" }, { word: "WHO", hint: "èª°" }, { word: "YES", hint: "æ˜¯çš„" }],
                "U4": [{ word: "WHITE", hint: "ç™½è‰²" }, { word: "ORANGE", hint: "æ©˜è‰²" }, { word: "BLACK", hint: "é»‘è‰²" }, { word: "GREEN", hint: "ç¶ è‰²" }, { word: "YELLOW", hint: "é»ƒè‰²" }, { word: "BLUE", hint: "è—è‰²" }, { word: "COLOR", hint: "é¡è‰²" }, { word: "PINK", hint: "ç²‰ç´…è‰²" }, { word: "RED", hint: "ç´…è‰²" }, { word: "WHOSE", hint: "èª°çš„" }],
                "U5": [{ word: "WHERE", hint: "åœ¨å“ªè£¡" }, { word: "GROUP", hint: "å°çµ„" }, { word: "THERE IS", hint: "æœ‰ (å–®æ•¸)" }, { word: "CLASSROOM", hint: "æ•™å®¤" }, { word: "IT", hint: "å®ƒ" }, { word: "THERE ARE", hint: "æœ‰ (è¤‡æ•¸)" }, { word: "TELL", hint: "å‘Šè¨´" }, { word: "AT", hint: "åœ¨" }, { word: "GO", hint: "å»" }, { word: "ON", hint: "åœ¨...ä¸Šé¢" }],
                "U6": [{ word: "DRAW", hint: "ç•«ç•«" }, { word: "READ", hint: "é–±è®€" }, { word: "COUNT", hint: "æ•¸æ•¸" }, { word: "WRITE", hint: "å¯«" }, { word: "CAN", hint: "å¯ä»¥" }, { word: "CANT", hint: "ä¸èƒ½ (can't)" }, { word: "CANNOT", hint: "ä¸èƒ½" }, { word: "EAT", hint: "åƒ" }, { word: "RUN", hint: "è·‘" }, { word: "SLEEP", hint: "ç¡è¦º" }],
                "U7": [{ word: "THESE", hint: "é€™äº›" }, { word: "THOSE", hint: "é‚£äº›" }, { word: "COME TO", hint: "ä¾†åˆ°" }, { word: "TWO", hint: "äºŒ" }, { word: "WALK TO", hint: "èµ°å‘" }, { word: "BY BUS", hint: "æ­å…¬è»Š" }, { word: "FOUR", hint: "å››" }, { word: "HOW", hint: "å¦‚ä½•/æ€éº¼æ¨£" }, { word: "ONE", hint: "ä¸€" }, { word: "THREE", hint: "ä¸‰" }],
                "U8": [{ word: "DOES", hint: "åš (å–®æ•¸ç¬¬ä¸‰äººç¨±)" }, { word: "HOMEWORK", hint: "å®¶åº­ä½œæ¥­" }, { word: "DOESNT", hint: "ä¸åš (doesn't)" }, { word: "KNOW", hint: "çŸ¥é“" }, { word: "WITH", hint: "èˆ‡...ä¸€èµ·" }, { word: "DONT", hint: "ä¸åš (don't)" }, { word: "KICK", hint: "è¸¢" }, { word: "LETS", hint: "è®“æˆ‘å€‘ (let's)" }, { word: "WANT TO", hint: "æƒ³è¦" }, { word: "JUMP", hint: "è·³" }, { word: "DO", hint: "åš (å‹•è©)" }, { word: "PLAY", hint: "ç©" }],
                "U9": [{ word: "EIGHT", hint: "å…«" }, { word: "ELEVEN", hint: "åä¸€" }, { word: "WHAT TIME", hint: "ä»€éº¼æ™‚é–“" }, { word: "TWELVE", hint: "åäºŒ" }, { word: "FIVE", hint: "äº”" }, { word: "FOR", hint: "ç‚ºäº†" }, { word: "NINE", hint: "ä¹" }, { word: "SEVEN", hint: "ä¸ƒ" }, { word: "SIX", hint: "å…­" }, { word: "TEN", hint: "å" }],
                "U10": [{ word: "WINDY", hint: "å¤šé¢¨çš„" }, { word: "DRY", hint: "ä¹¾ç‡¥çš„" }, { word: "WARM", hint: "æº«æš–çš„" }, { word: "RAINY", hint: "ä¸‹é›¨çš„" }, { word: "COLD", hint: "å¯’å†·çš„" }, { word: "HOT", hint: "ç‚ç†±çš„" }, { word: "OR", hint: "æˆ–è€…" }, { word: "SUNNY", hint: "æ™´æœ—çš„" }, { word: "TODAY", hint: "ä»Šå¤©" }, { word: "WET", hint: "æ½®æ¿•çš„" }]
            },
            "G2": {
                "U1": [{ word: "ARM", hint: "æ‰‹è‡‚" }, { word: "BACK", hint: "èƒŒéƒ¨" }, { word: "BODY", hint: "èº«é«”" }, { word: "FEET", hint: "è…³ (è¤‡æ•¸)" }, { word: "FINGER", hint: "æ‰‹æŒ‡" }, { word: "FOOT", hint: "è…³ (å–®æ•¸)" }, { word: "HAND", hint: "æ‰‹" }, { word: "HAS", hint: "æœ‰ (å–®æ•¸ç¬¬ä¸‰äººç¨±)" }, { word: "HAVE", hint: "æœ‰ (å‹•è©)" }, { word: "LEG", hint: "è…¿" }, { word: "THUMB", hint: "æ‹‡æŒ‡" }, { word: "TOE", hint: "è…³è¶¾" }],
                "U2": [{ word: "BIG", hint: "å¤§çš„" }, { word: "EAR", hint: "è€³æœµ" }, { word: "EYE", hint: "çœ¼ç›" }, { word: "HAIR", hint: "é ­é«®" }, { word: "LITTLE", hint: "å°çš„" }, { word: "LONG", hint: "é•·çš„" }, { word: "MOUTH", hint: "å˜´å·´" }, { word: "NOSE", hint: "é¼»å­" }, { word: "NOW", hint: "ç¾åœ¨" }, { word: "SHORT", hint: "çŸ­çš„/çŸ®çš„" }],
                "U3": [{ word: "COAT", hint: "å¤–å¥—" }, { word: "DRESS", hint: "æ´‹è£" }, { word: "GLASSES", hint: "çœ¼é¡" }, { word: "PANTS", hint: "è¤²å­" }, { word: "SHIRT", hint: "è¥¯è¡«" }, { word: "SHOES", hint: "é‹å­" }, { word: "SHORTS", hint: "çŸ­è¤²" }, { word: "SKIRT", hint: "è£™å­" }, { word: "SOCKS", hint: "è¥ªå­" }, { word: "SWEATER", hint: "æ¯›è¡£" }],
                "U4": [{ word: "TIRED", hint: "ç´¯çš„" }, { word: "HAPPY", hint: "å¿«æ¨‚çš„" }, { word: "SAD", hint: "æ‚²å‚·çš„" }, { word: "BORED", hint: "ç„¡èŠçš„" }, { word: "ANGRY", hint: "ç”Ÿæ°£çš„" }, { word: "CRAZY", hint: "ç˜‹ç‹‚çš„" }, { word: "HUNGRY", hint: "é£¢é¤“çš„" }, { word: "THIRSTY", hint: "å£æ¸´çš„" }, { word: "SICK", hint: "ç”Ÿç—…çš„" }, { word: "SCARED", hint: "å®³æ€•çš„" }],
                "U5": [{ word: "MONTH", hint: "æœˆä»½" }, { word: "JANUARY", hint: "ä¸€æœˆ" }, { word: "FEBRUARY", hint: "äºŒæœˆ" }, { word: "MARCH", hint: "ä¸‰æœˆ" }, { word: "APRIL", hint: "å››æœˆ" }, { word: "MAY", hint: "äº”æœˆ" }, { word: "JUNE", hint: "å…­æœˆ" }, { word: "JULY", hint: "ä¸ƒæœˆ" }, { word: "AUGUST", hint: "å…«æœˆ" }, { word: "SEPTEMBER", hint: "ä¹æœˆ" }, { word: "OCTOBER", hint: "åæœˆ" }, { word: "NOVEMBER", hint: "åä¸€æœˆ" }, { word: "DECEMBER", hint: "åäºŒæœˆ" }]
            }
        };

        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let currentWord = "";
        let currentSpelling = [];
        let currentWordList = [];
        let wordIndex = 0;
        let errorList = [];
        let isReviewMode = false;
        let currentGrade = null; 
        let selectedUnits = []; 
        const keys = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        
        // DOM å…ƒç´ 
        const hintDisplay = document.getElementById('hint-display');
        const reviewStatus = document.getElementById('review-status');
        const gradeButtonsContainer = document.getElementById('grade-buttons-container'); 
        const unitButtonsContainer = document.getElementById('unit-buttons-container'); 
        const inputArea = document.getElementById('input-area');
        const startBtn = document.getElementById('start-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const checkBtn = document.getElementById('check-btn');
        const answerBtn = document.getElementById('answer-btn');
        const feedbackMessage = document.getElementById('feedback-message');

        // èªéŸ³åˆæˆç‰©ä»¶
        const synth = window.speechSynthesis;
        let englishVoice = null;

        // --- é¸æ“‡å™¨èˆ‡å–®å­—è¼‰å…¥ ---
        
        /**
         * è™•ç†å¹´ç´šæŒ‰éˆ•é»æ“Šäº‹ä»¶ (å¾ HTML onclick èª¿ç”¨)
         */
        function selectGrade(clickedButton) {
            const grade = clickedButton.dataset.grade;
            
            // è¦–è¦ºæ•ˆæœï¼šæ¸…é™¤æ‰€æœ‰å¹´ç´šæŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
            
            // è¨­ç½®ç•¶å‰å¹´ç´šä¸¦é«˜äº®
            currentGrade = grade;
            clickedButton.classList.add('selected');
            
            // è¼‰å…¥è©²å¹´ç´šçš„å–®å…ƒæŒ‰éˆ•
            loadUnits(currentGrade);
        }

        /**
         * è¼‰å…¥å–®å…ƒæŒ‰éˆ•
         */
        function loadUnits(grade) {
            unitButtonsContainer.innerHTML = '';
            selectedUnits = []; 
            
            if (grade && allWordUnits[grade]) {
                const units = allWordUnits[grade];
                Object.keys(units).forEach(unit => {
                    const button = document.createElement('button');
                    button.className = 'unit-btn';
                    // ã€å¤§è€³ç‹—é¢¨æ ¼ã€‘åœ¨å–®å…ƒæŒ‰éˆ•å‰åŠ  Emoji
                    button.textContent = `ğŸŒ¸ ${unit} (${units[unit].length})`; 
                    button.dataset.unit = unit; 
                    button.onclick = toggleUnitSelection; 
                    unitButtonsContainer.appendChild(button);
                });
            } else {
                 unitButtonsContainer.innerHTML = 'è«‹å…ˆé¸æ“‡å¹´ç´š';
            }
            checkSelectionStatus();
        }

        /**
         * é»æ“ŠæŒ‰éˆ•åˆ‡æ›å–®å…ƒé¸ä¸­ç‹€æ…‹
         */
        function toggleUnitSelection() {
            const unit = this.dataset.unit;
            const index = selectedUnits.indexOf(unit);

            if (index > -1) {
                // å·²é¸ä¸­ -> å–æ¶ˆé¸ä¸­
                selectedUnits.splice(index, 1);
                this.classList.remove('selected');
            } else {
                // æœªé¸ä¸­ -> é¸ä¸­
                selectedUnits.push(unit);
                this.classList.add('selected');
            }
            checkSelectionStatus();
        }

        /**
         * æª¢æŸ¥æ˜¯å¦æœ‰å–®å…ƒè¢«é¸ä¸­ï¼Œæ±ºå®šæ˜¯å¦å•Ÿç”¨é–‹å§‹æŒ‰éˆ•
         */
        function checkSelectionStatus() {
            if (currentGrade && selectedUnits.length > 0) {
                startBtn.disabled = false;
                hintDisplay.textContent = `å·²é¸æ“‡ ${currentGrade} çš„ ${selectedUnits.length} å€‹å–®å…ƒï¼Œé»æ“Šé–‹å§‹éŠæˆ²ï¼`;
            } else if (currentGrade) {
                startBtn.disabled = true;
                hintDisplay.textContent = 'è«‹é¸æ“‡è¦ç·´ç¿’çš„èª²åˆ¥ï¼';
            } else {
                startBtn.disabled = true;
                hintDisplay.textContent = 'è«‹å…ˆé¸æ“‡å¹´ç´šï¼';
            }
        }
        
        // --- éŠæˆ²é‚è¼¯å‡½æ•¸ ---
        
        // 3. ã€èªéŸ³å„ªåŒ–ã€‘è¨­å®šç™¼éŸ³å¼•æ“ï¼Œå„ªå…ˆé¸æ“‡éŸ³é«˜è¼ƒé«˜çš„è²éŸ³
        function setEnglishVoice() {
            if (englishVoice) return;
            const voices = synth.getVoices();
            // ç¯©é¸å‡º US/GB è‹±æ–‡å¥³è²ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æ‰¾ç¬¬ä¸€å€‹è‹±æ–‡è²éŸ³
            englishVoice = voices.find(voice => 
                (voice.lang.startsWith('en-US') || voice.lang.startsWith('en-GB')) && 
                voice.name.includes('Female')
            ) || voices.find(voice => voice.lang.startsWith('en'));
        }
        synth.onvoiceschanged = setEnglishVoice;
        
        /**
         * èªéŸ³åˆæˆå‡½æ•¸
         * @param {string} text è¦å”¸å‡ºçš„æ–‡å­—
         * @param {number} rate èªé€Ÿ
         * @param {number} pitch éŸ³é«˜
         */
        function speak(text, rate = 0.9, pitch = 1.0) {
            if (synth.speaking) {
                synth.cancel();
            }
            setEnglishVoice();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.voice = englishVoice;
            utterThis.lang = 'en-US'; 
            utterThis.rate = rate; 
            utterThis.pitch = pitch; // æ–°å¢éŸ³é«˜è¨­å®š
            synth.speak(utterThis);
            return utterThis;
        }

        /**
         * æœ—è®€å–®å­—ï¼Œç›´æ¥å”¸å‡ºå®Œæ•´çš„è©çµ„ã€‚
         * èª¿æ•´èªé€Ÿå’ŒéŸ³é«˜ï¼Œè®“è²éŸ³æ›´åƒå°æœ‹å‹/å¥³è€å¸«ã€‚
         * @param {string} word å¯¦éš›è¦æ‹¼å¯«çš„å–®å­—/è©çµ„
         */
        function readWord(word) {
            repeatBtn.disabled = true; 
            
            let speechWord = word; 
            
            // 4. ã€ç™¼éŸ³ä¿®æ­£ã€‘å°‡èªé€Ÿèª¿ç‚º 0.9ï¼ŒéŸ³é«˜èª¿é«˜åˆ° 1.2
            const utterThis = speak(speechWord, 0.9, 1.2); 
            utterThis.onend = () => {
                repeatBtn.disabled = false;
            };
        }
        
        /**
         * å•Ÿå‹•/é‡å•ŸéŠæˆ²æˆ–è¤‡ç¿’æ¨¡å¼
         */
        function startGame() {
            if (!isReviewMode) {
                if (!currentGrade || selectedUnits.length === 0) {
                    hintDisplay.textContent = 'è«‹å…ˆé¸æ“‡å¹´ç´šå’Œèª²åˆ¥ï¼';
                    return;
                }
                
                currentWordList = [];
                errorList = [];
                selectedUnits.forEach(unit => {
                    currentWordList = currentWordList.concat(allWordUnits[currentGrade][unit]);
                });

                currentWordList.sort(() => Math.random() - 0.5); 
                wordIndex = 0;
            } else if (errorList.length > 0) {
                currentWordList = [...errorList];
                wordIndex = 0;
                errorList = [];
            } else {
                endGame();
                return;
            }
            
            reviewStatus.textContent = isReviewMode ? 
                `ğŸ”´ éŒ¯èª¤è¤‡ç¿’æ¨¡å¼ï¼šå…± ${currentWordList.length} é¡Œ` : ``;

            checkBtn.disabled = true;
            answerBtn.disabled = false;
            startBtn.textContent = 'ä¸‹ä¸€å€‹å–®å­—';
            
            loadNextWord();
        }

        /**
         * è¼‰å…¥ä¸‹ä¸€çµ„å–®å­— (è™•ç†ç©ºæ ¼ä¸¦ç”Ÿæˆè¼¸å…¥æ ¼å­)
         */
        function loadNextWord() {
            if (wordIndex >= currentWordList.length) {
                if (errorList.length > 0) {
                    isReviewMode = true;
                    setTimeout(() => {
                        const totalErrors = errorList.length;
                        if (confirm(`ğŸ‰ æœ¬è¼ªå®Œæˆï¼æ‚¨æœ‰ ${totalErrors} å€‹å–®å­—éœ€è¦è¤‡ç¿’ã€‚ç¾åœ¨é–‹å§‹è¤‡ç¿’å—ï¼Ÿ`)) {
                            startGame();
                        } else {
                            endGame();
                        }
                    }, 500);
                } else {
                    endGame();
                }
                return;
            }
            
            const wordData = currentWordList[wordIndex];
            currentWord = wordData.word;
            currentSpelling = [];
            
            inputArea.innerHTML = '';
            feedbackMessage.textContent = '';
            
            const unitInfo = isReviewMode ? "è¤‡ç¿’é¡Œ" : `ç¬¬ ${wordIndex + 1}/${currentWordList.length} é¡Œ`;
            hintDisplay.textContent = `[${unitInfo}] ${wordData.hint}`;

            // è™•ç†ç©ºæ ¼ï¼šå°‡æ‰€æœ‰å­—å…ƒ (åŒ…æ‹¬ç©ºæ ¼) è½‰ç‚ºé™£åˆ—
            const targetChars = currentWord.split(''); 
            
            let letterIndex = 0;
            targetChars.forEach((char, i) => {
                if (char === ' ') {
                    // é‡åˆ°ç©ºæ ¼æ™‚ï¼Œç”Ÿæˆä¸€å€‹è™›æ“¬ç©ºæ ¼æ§½ (space-slot)ï¼Œå¯¦ç¾ä¸­é–“åˆ†é–‹çš„æ•ˆæœ
                    const spaceSlot = document.createElement('div');
                    spaceSlot.className = 'space-slot';
                    inputArea.appendChild(spaceSlot);
                } else {
                    // é‡åˆ°å­—æ¯æ™‚ï¼Œç”Ÿæˆä¸€å€‹å­—æ¯æ§½ (letter-slot)
                    const slot = document.createElement('div');
                    slot.className = 'letter-slot';
                    // é€™è£¡çš„ ID å¿…é ˆåªé‡å°å­—æ¯éƒ¨åˆ†é€²è¡Œç·¨è™Ÿ
                    slot.id = `slot-${letterIndex}`;
                    inputArea.appendChild(slot);
                    letterIndex++;
                }
            });
            
            readWord(currentWord);
        }

        function endGame() {
            isReviewMode = false;
            currentWordList = [];
            wordIndex = 0;
            errorList = [];
            inputArea.innerHTML = '';
            checkBtn.disabled = true;
            answerBtn.disabled = true;
            repeatBtn.disabled = true;
            reviewStatus.textContent = '';
            startBtn.textContent = 'é‡æ–°é–‹å§‹';
            
            hintDisplay.textContent = 'ğŸ‘ æ­å–œæ‚¨ï¼æ‰€æœ‰å–®å­—æ¸¬é©—å’Œè¤‡ç¿’éƒ½å·²å®Œæˆï¼';
            feedbackMessage.textContent = 'è«‹é¸æ“‡æ–°çš„å–®å…ƒé–‹å§‹ä¸‹ä¸€è¼ªç·´ç¿’ã€‚';
        }

        /**
         * è™•ç†éµç›¤å­—æ¯é»æ“Š
         */
        function handleKeyClick(letter) {
            if (currentWord === "") return;
            
            // å–å¾—ç›®æ¨™å–®å­—ä¸­å»é™¤ç©ºæ ¼çš„é•·åº¦
            const pureWord = currentWord.replace(/\s/g, ''); 
            
            if (currentSpelling.length < pureWord.length) {
                currentSpelling.push(letter);
                const currentSlot = document.getElementById(`slot-${currentSpelling.length - 1}`);
                currentSlot.textContent = letter;
            }
            if (currentSpelling.length === pureWord.length) {
                checkBtn.disabled = false;
            }
        }
        
        /**
         * è™•ç† DELETE éµé»æ“Š (æ–°å¢åŠŸèƒ½)
         */
        function handleDeleteClick() {
            if (currentSpelling.length > 0) {
                // 1. æ¸…é™¤é¡¯ç¤º
                const lastSlotIndex = currentSpelling.length - 1;
                const lastSlot = document.getElementById(`slot-${lastSlotIndex}`);
                if (lastSlot) {
                    lastSlot.textContent = ''; // æ¸…ç©ºæ ¼å­é¡¯ç¤º
                }
                
                // 2. ç§»é™¤æ•¸æ“š
                currentSpelling.pop(); 
                
                // 3. ç¦ç”¨æª¢æŸ¥æŒ‰éˆ• (å¦‚æœè¼¸å…¥æ¸…ç©º)
                if (currentSpelling.length === 0) {
                    checkBtn.disabled = true;
                }
            }
        }


        function checkSpelling() {
            // ç«‹å³é–å®šæŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            checkBtn.disabled = true;
            repeatBtn.disabled = true;
            answerBtn.disabled = true; 
            
            const playerWord = currentSpelling.join('');
            // ç§»é™¤ç›®æ¨™å–®å­—ä¸­çš„ç©ºæ ¼é€²è¡Œæ¯”å°
            const pureWord = currentWord.replace(/\s/g, ''); 

            if (playerWord === pureWord) {
                // ã€å¤§è€³ç‹—é¢¨æ ¼ã€‘æˆåŠŸåé¥‹æ›¿æ›ç‚ºå¯æ„›çš„æ£’æ£’ç³–
                feedbackMessage.textContent = 'ğŸ­ å¤ªæ£’äº†ï¼æ‹¼å¯«å®Œå…¨æ­£ç¢ºï¼'; 
                // èªéŸ³å ±è®€æ­£ç¢ºç­”æ¡ˆ (ä½¿ç”¨è¼ƒå¿«çš„ 1.0 èªé€Ÿå’Œæ¨™æº– 1.0 éŸ³é«˜)
                speak('Excellent! The word is ' + currentWord, 1.0, 1.0);
                
                for (let i = 0; i < pureWord.length; i++) {
                    document.getElementById(`slot-${i}`).classList.add('correct');
                }
                
                wordIndex++;
                // æˆåŠŸå¾Œå¿«é€Ÿé€²å…¥ä¸‹ä¸€é¡Œ (1.5 ç§’å»¶é²)
                setTimeout(loadNextWord, 1500);
            } else {
                feedbackMessage.textContent = 'ğŸ’¡ éŒ¯å›‰ï¼å³å°‡é‡å”¸ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼';
                
                for (let i = 0; i < pureWord.length; i++) {
                    const slot = document.getElementById(`slot-${i}`);
                    if (currentSpelling[i] && currentSpelling[i] === pureWord[i]) {
                        slot.classList.add('correct');
                    } else {
                        slot.classList.add('incorrect');
                    }
                }
                
                const currentWordData = currentWordList[wordIndex];
                if (!errorList.find(w => w.word === currentWordData.word)) {
                    errorList.push(currentWordData);
                }
                
                // éŒ¯èª¤å¾Œç«‹å³æ¸…ç©ºï¼Œç°¡åŒ–é‡è©¦æµç¨‹
                resetForRetry(); 
                answerBtn.disabled = false;
                
                // 1.5 ç§’å¾Œè‡ªå‹•é‡å”¸å–®å­—
                setTimeout(() => readWord(currentWord), 1500); 
            }
        }
        
        function resetForRetry() {
            feedbackMessage.textContent = 'è«‹å†è©¦ä¸€æ¬¡ï¼é»æ“Šå­—æ¯é‡æ–°è¼¸å…¥ã€‚';
            currentSpelling = [];
            
            // å–å¾—ç›®æ¨™å–®å­—ä¸­å»é™¤ç©ºæ ¼çš„é•·åº¦
            const pureWord = currentWord.replace(/\s/g, '');
            
            for (let i = 0; i < pureWord.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) {
                    slot.textContent = '';
                    slot.classList.remove('correct', 'incorrect', 'skipped');
                }
            }
            repeatBtn.disabled = false;
        }

        function showAnswer() {
            const word = currentWord;
            const pureWord = word.replace(/\s/g, '');
            
            for (let i = 0; i < pureWord.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) {
                    slot.textContent = pureWord[i];
                    slot.classList.add('skipped');
                }
            }
            
            feedbackMessage.textContent = `ç­”æ¡ˆæ˜¯ ${word}ã€‚é€™å€‹å–®å­—å·²åŠ å…¥å¾…è¤‡ç¿’æ¸…å–®ï¼`;
            speak(`The correct word is ${word}`);
            
            const currentWordData = currentWordList[wordIndex];
            if (!errorList.find(w => w.word === currentWordData.word)) {
                 errorList.push(currentWordData);
            }
            
            wordIndex++;
            checkBtn.disabled = true;
            answerBtn.disabled = true;
            
            // çœ‹ç­”æ¡ˆå¾Œå¿«é€Ÿé€²å…¥ä¸‹ä¸€é¡Œ
            setTimeout(loadNextWord, 1500);
        }


        // --- åˆå§‹åŒ– ---
        function createKeyboard() {
            const keyboardDiv = document.getElementById('keyboard');
            
            keys.forEach(letter => {
                const keyBtn = document.createElement('button');
                keyBtn.className = 'key';
                keyBtn.textContent = letter;
                keyBtn.onclick = () => handleKeyClick(letter);
                keyboardDiv.appendChild(keyBtn);
            });
            
            // æ–°å¢ DELETE éµ
            const deleteKey = document.createElement('button');
            deleteKey.id = 'delete-key';
            deleteKey.className = 'key';
            deleteKey.textContent = 'DEL';
            deleteKey.onclick = handleDeleteClick;
            keyboardDiv.appendChild(deleteKey);
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            createKeyboard();
            checkSelectionStatus(); 
        };
        
        repeatBtn.onclick = () => readWord(currentWord); 
        checkBtn.onclick = checkSpelling;
        
    </script>

</body>
</html>
