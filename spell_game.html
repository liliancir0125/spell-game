<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡è½å¯«ç·´ç¿’æ©Ÿ (å¹³æ¿å„ªåŒ– V3.0.3)</title>
    <style>
        /* ------------------- CSS æ¨£å¼ ------------------- */
        body {
            font-family: 'Arial', sans-serif;
            /* æ¢å¾©åŸå§‹ç´”æ·¨çš„ç™½è‰²èƒŒæ™¯ */
            background-color: #f7f7f7; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 30px; 
            color: #333;
        }

        #game-container {
            width: 95%; 
            /* ã€æ©«å‘å„ªåŒ–ã€‘å¢åŠ æœ€å¤§å¯¬åº¦ï¼Œé©ç”¨ iPad æ©«å± */
            max-width: 900px; 
            border: 5px solid #a4e2ff; 
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
        }

        h2 {
            /* æ¨™é¡Œå¸¶æœ‰ç‰ˆæœ¬è™Ÿ */
            color: #4a90e2; 
        }

        /* ------------------- é¸æ“‡ä»‹é¢å„ªåŒ– ------------------- */
        #selection-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #grade-buttons-container {
            display: flex;
            justify-content: center;
            gap: 30px; 
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        #unit-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; 
            margin-bottom: 15px;
            min-height: 50px;
        }

        /* çµ±ä¸€çš„æŒ‰éˆ•æ¨£å¼ */
        .unit-btn {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #ffb3c1; 
            border-radius: 8px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: all 0.1s;
        }
        
        .grade-btn { 
            padding: 10px 25px;
            font-size: 18px;
            font-weight: bold;
        }

        .unit-btn.selected {
            background-color: #4a90e2; 
            color: white;
            border-color: #4a90e2;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* ------------------- éŠæˆ²ç‹€æ…‹é¡¯ç¤º ------------------- */
        #review-status {
            font-size: 18px;
            color: #d9534f;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        #hint-display {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 20px;
            min-height: 30px;
        }

        /* ------------------- è¼¸å…¥å€å„ªåŒ– ------------------- */
        #input-area {
            display: flex;
            justify-content: center;
            gap: 10px; 
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .letter-slot {
            width: 50px; 
            height: 60px; 
            line-height: 60px;
            font-size: 34px; 
            font-weight: bold;
            border: 3px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
        }

        .space-slot {
            width: 25px; 
            height: 60px;
            background-color: transparent;
            border: none;
        }

        /* ------------------- éµç›¤èˆ‡æ§åˆ¶æŒ‰éˆ•å„ªåŒ– ------------------- */
        #keyboard {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px; 
            margin-top: 20px;
        }

        .key {
            background-color: #a4e2ff; 
            color: #333; 
            border: none;
            padding: 15px 0; 
            font-size: 24px; 
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .key:active {
            background-color: #79c5f0; 
        }
        
        #delete-key {
            background-color: #777;
            color: white;
            font-size: 20px;
        }

        #delete-key:active {
            background-color: #555;
        }


        #control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px; 
            margin-top: 30px;
        }

        .control-btn {
            padding: 15px 30px; 
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px #999;
            transition: all 0.1s;
        }

        .control-btn:active {
            box-shadow: 0 0 #999;
            transform: translateY(4px);
        }

        #repeat-btn {
            background-color: #5cb85c;
            color: white;
        }

        #check-btn {
            background-color: #f0ad4e;
            color: white;
        }
        
        #answer-btn {
            background-color: #5bc0de;
            color: white;
        }

        /* åé¥‹æ•ˆæœ */
        .correct {
            background-color: #aaffaa !important;
            border-color: #4CAF50 !important;
        }

        .incorrect {
            background-color: #ffaaaa !important;
            border-color: #f44336 !important;
        }

        .skipped {
            background-color: #ffe4b2 !important; 
            border-color: #ff8c00 !important;
        }

        #feedback-message {
            font-size: 30px; 
            font-weight: bold;
            min-height: 35px;
            margin-top: 15px;
            color: #4a90e2;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <h2>â˜ï¸ è‹±æ–‡è½å¯«ç·´ç¿’æ©Ÿ V3.0.3</h2>
        
        <div id="review-status"></div>

        <div id="selection-controls">
            <div id="grade-buttons-container">
                <button class="grade-btn unit-btn" data-grade="G1" onclick="selectGrade(this)">G1</button>
                <button class="grade-btn unit-btn" data-grade="G2" onclick="selectGrade(this)">G2</button>
            </div>

            <div id="unit-buttons-container">
                è«‹å…ˆé¸æ“‡å¹´ç´š
            </div>
        </div>

        <div id="hint-display">è«‹å…ˆé¸æ“‡å¹´ç´šå’Œå–®å…ƒæŒ‰éˆ•ï¼Œç„¶å¾Œé»æ“Šé–‹å§‹ï¼</div>
        
        <div id="input-area"></div>

        <div id="control-buttons">
            <button id="start-btn" class="control-btn" onclick="handleStartNext()" disabled>é–‹å§‹éŠæˆ²</button> 
            <button id="repeat-btn" class="control-btn" disabled>ğŸ”ˆ é‡è¤‡å”¸ä¸€æ¬¡</button>
            <button id="check-btn" class="control-btn" disabled>âœ… æª¢æŸ¥æ‹¼å¯«</button>
            <button id="answer-btn" class="control-btn" onclick="showAnswer()" disabled>ğŸ“– çœ‹è§£ç­”</button>
        </div>

        <div id="feedback-message"></div>

        <div id="keyboard"></div>
    </div>

    <script>
        // ------------------- JavaScript é‚è¼¯ -------------------

        // 1. å–®å­—åº« (G1 å–®å­—å’Œä¸­æ–‡æç¤ºå·²æ›´æ–°ï¼Œä¸¦å°‡ First å’Œ Grade åˆä½µç‚º FIRST GRADE)
        const allWordUnits = {
            "G1": {
                "U1": [
                    { word: "HE IS", hint: "ä»–æ˜¯" }, 
                    { word: "I AM", hint: "æˆ‘æ˜¯" }, 
                    { word: "NAME", hint: "åå­—" }, 
                    { word: "SHE IS", hint: "å¥¹æ˜¯" }, 
                    { word: "THE", hint: "é€™å€‹" }, 
                    { word: "THIS", hint: "é€™å€‹" }, 
                    { word: "YOU ARE", hint: "ä½ æ˜¯" }, 
                    { word: "WHAT", hint: "ä»€éº¼" }
                ],
                "U2": [
                    { word: "THAT", hint: "é‚£å€‹" }, 
                    { word: "AND", hint: "å’Œ" }, 
                    { word: "OUR", hint: "æˆ‘å€‘çš„" }, 
                    { word: "HER", hint: "å¥¹çš„" }, 
                    { word: "HIS", hint: "ä»–çš„" }, 
                    { word: "MY", hint: "æˆ‘çš„" }, 
                    { word: "OPEN", hint: "æ‰“é–‹" }, 
                    { word: "YOUR", hint: "ä½ çš„" }, 
                    { word: "THEY", hint: "ä»–å€‘" }, 
                    { word: "CLOSE", hint: "é—œä¸Š" }, 
                    { word: "WE", hint: "æˆ‘å€‘" }, 
                    { word: "THEIR", hint: "ä»–å€‘çš„" }
                ],
                "U3": [
                    { word: "SCHOOL", hint: "å­¸æ ¡" }, 
                    { word: "GOOD", hint: "å¥½çš„" }, 
                    { word: "FIRST GRADE", hint: "ä¸€å¹´ç´š" }, 
                    { word: "HELLO", hint: "å“ˆå›‰" }, 
                    { word: "IN", hint: "åœ¨" }, 
                    { word: "NO", hint: "ä¸" }, 
                    { word: "NOT", hint: "ä¸" }, 
                    { word: "TOO", hint: "ä¹Ÿæ˜¯" }, 
                    { word: "WHO", hint: "èª°" }, 
                    { word: "YES", hint: "æ˜¯" }
                ],
                "U4": [
                    { word: "WHITE", hint: "ç™½è‰²" }, 
                    { word: "ORANGE", hint: "æ©˜è‰²" }, 
                    { word: "BLACK", hint: "é»‘è‰²" }, 
                    { word: "GREEN", hint: "ç¶ è‰²" }, 
                    { word: "YELLOW", hint: "é»ƒè‰²" }, 
                    { word: "BLUE", hint: "è—è‰²" }, 
                    { word: "COLOR", hint: "é¡è‰²" }, 
                    { word: "PINK", hint: "ç²‰ç´…è‰²" }, 
                    { word: "RED", hint: "ç´…è‰²" }, 
                    { word: "WHOSE", hint: "èª°çš„" }
                ],
                "U5": [
                    { word: "WHERE", hint: "å“ªè£¡" }, 
                    { word: "GROUP", hint: "çµ„" }, 
                    { word: "THERE IS", hint: "æœ‰ (å–®æ•¸)" }, 
                    { word: "CLASSROOM", hint: "æ•™å®¤" }, 
                    { word: "IT", hint: "å®ƒ" }, 
                    { word: "THERE ARE", hint: "æœ‰ (è¤‡æ•¸)" }, 
                    { word: "TELL", hint: "å‘Šè¨´" }, 
                    { word: "AT", hint: "åœ¨æ–¼" }, 
                    { word: "GO", hint: "å»" }, 
                    { word: "ON", hint: "åœ¨...ä¸Šé¢" }
                ],
                "U6": [
                    { word: "DRAW", hint: "ç•«ç•«" }, 
                    { word: "READ", hint: "é–±è®€" }, 
                    { word: "COUNT", hint: "æ•¸æ•¸" }, 
                    { word: "WRITE", hint: "å¯«" }, 
                    { word: "CAN", hint: "å¯ä»¥" }, 
                    { word: "CANT", hint: "ä¸å¯ä»¥" }, 
                    { word: "CANNOT", hint: "ä¸å¯ä»¥" }, 
                    { word: "EAT", hint: "åƒ" }, 
                    { word: "RUN", hint: "è·‘" }, 
                    { word: "SLEEP", hint: "ç¡è¦º" }
                ],
                "U7": [
                    { word: "THESE", hint: "é€™äº›" }, 
                    { word: "THOSE", hint: "é‚£äº›" }, 
                    { word: "COME TO", hint: "ä¾†" }, 
                    { word: "TWO", hint: "äºŒ" }, 
                    { word: "WALK TO", hint: "èµ°åˆ°" }, 
                    { word: "BY BUS", hint: "æ­å…¬è»Š" }, 
                    { word: "FOUR", hint: "å››" }, 
                    { word: "HOW", hint: "å¦‚ä½•" }, 
                    { word: "ONE", hint: "ä¸€" }, 
                    { word: "THREE", hint: "ä¸‰" }
                ],
                "U8": [
                    { word: "DOES", hint: "åš" }, 
                    { word: "HOMEWORK", hint: "å®¶åº­ä½œæ¥­" }, 
                    { word: "DOESNT", hint: "ä¸ (doesn't)" }, 
                    { word: "KNOW", hint: "çŸ¥é“" }, 
                    { word: "WITH", hint: "å’Œ" }, 
                    { word: "DONT", hint: "ä¸ (don't)" }, 
                    { word: "KICK", hint: "è¸¢" }, 
                    { word: "LETS", hint: "è®“æˆ‘å€‘" }, 
                    { word: "WANT TO", hint: "æƒ³è¦" }, 
                    { word: "JUMP", hint: "è·³" }, 
                    { word: "DO", hint: "åš" }, 
                    { word: "PLAY", hint: "ç©" }
                ],
                "U9": [
                    { word: "EIGHT", hint: "å…«" }, 
                    { word: "ELEVEN", hint: "åä¸€" }, 
                    { word: "WHAT TIME", hint: "å¹¾é»é˜" }, 
                    { word: "TWELVE", hint: "åäºŒ" }, 
                    { word: "FIVE", hint: "äº”" }, 
                    { word: "FOR", hint: "çµ¦" }, 
                    { word: "NINE", hint: "ä¹" }, 
                    { word: "SEVEN", hint: "ä¸ƒ" }, 
                    { word: "SIX", hint: "å…­" }, 
                    { word: "TEN", hint: "å" }
                ],
                "U10": [
                    { word: "WINDY", hint: "é¢¨å¤§çš„" }, 
                    { word: "DRY", hint: "ä¹¾çš„" }, 
                    { word: "WARM", hint: "æº«æš–çš„" }, 
                    { word: "RAINY", hint: "ä¸‹é›¨çš„" }, 
                    { word: "COLD", hint: "å¯’å†·çš„" }, 
                    { word: "HOT", hint: "ç‚ç†±çš„" }, 
                    { word: "OR", hint: "æˆ–è€…" }, 
                    { word: "SUNNY", hint: "æ™´æœ—çš„" }, 
                    { word: "TODAY", hint: "ä»Šå¤©" }, 
                    { word: "WET", hint: "æ½®æ¿•çš„" }
                ]
            },
            "G2": {
                // G2 å–®å­—åº«ä¿æŒä¸è®Š
                "U1": [{ word: "ARM", hint: "æ‰‹è‡‚" }, { word: "BACK", hint: "èƒŒéƒ¨" }, { word: "BODY", hint: "èº«é«”" }, { word: "FEET", hint: "è…³ (è¤‡æ•¸)" }, { word: "FINGER", hint: "æ‰‹æŒ‡" }, { word: "FOOT", hint: "è…³ (å–®æ•¸)" }, { word: "HAND", hint: "æ‰‹" }, { word: "HAS", hint: "æœ‰ (å–®æ•¸ç¬¬ä¸‰äººç¨±)" }, { word: "HAVE", hint: "æœ‰ (å‹•è©)" }, { word: "LEG", hint: "è…¿" }, { word: "THUMB", hint: "æ‹‡æŒ‡" }, { word: "TOE", hint: "è…³è¶¾" }],
                "U2": [{ word: "BIG", hint: "å¤§çš„" }, { word: "EAR", hint: "è€³æœµ" }, { word: "EYE", hint: "çœ¼ç›" }, { word: "HAIR", hint: "é ­é«®" }, { word: "LITTLE", hint: "å°çš„" }, { word: "LONG", hint: "é•·çš„" }, { word: "MOUTH", hint: "å˜´å·´" }, { word: "NOSE", hint: "é¼»å­" }, { word: "NOW", hint: "ç¾åœ¨" }, { word: "SHORT", hint: "çŸ­çš„/çŸ®çš„" }],
                "U3": [{ word: "COAT", hint: "å¤–å¥—" }, { word: "DRESS", hint: "æ´‹è£" }, { word: "GLASSES", hint: "çœ¼é¡" }, { word: "PANTS", hint: "è¤²å­" }, { word: "SHIRT", hint: "è¥¯è¡«" }, { word: "SHOES", hint: "é‹å­" }, { word: "SHORTS", hint: "çŸ­è¤²" }, { word: "SKIRT", hint: "è£™å­" }, { word: "SOCKS", hint: "è¥ªå­" }, { word: "SWEATER", hint: "æ¯›è¡£" }],
                "U4": [{ word: "TIRED", hint: "ç´¯çš„" }, { word: "HAPPY", hint: "å¿«æ¨‚çš„" }, { word: "SAD", hint: "æ‚²å‚·çš„" }, { word: "BORED", hint: "ç„¡èŠçš„" }, { word: "ANGRY", hint: "ç”Ÿæ°£çš„" }, { word: "CRAZY", hint: "ç˜‹ç‹‚çš„" }, { word: "HUNGRY", hint: "é£¢é¤“çš„" }, { word: "THIRSTY", hint: "å£æ¸´çš„" }, { word: "SICK", hint: "ç”Ÿç—…çš„" }, { word: "SCARED", hint: "å®³æ€•çš„" }],
                "U5": [{ word: "MONTH", hint: "æœˆä»½" }, { word: "JANUARY", hint: "ä¸€æœˆ" }, { word: "FEBRUARY", hint: "äºŒæœˆ" }, { word: "MARCH", hint: "ä¸‰æœˆ" }, { word: "APRIL", hint: "å››æœˆ" }, { word: "MAY", hint: "äº”æœˆ" }, { word: "JUNE", hint: "å…­æœˆ" }, { word: "JULY", hint: "ä¸ƒæœˆ" }, { word: "AUGUST", hint: "å…«æœˆ" }, { word: "SEPTEMBER", hint: "ä¹æœˆ" }, { word: "OCTOBER", hint: "åæœˆ" }, { word: "NOVEMBER", hint: "åä¸€æœˆ" }, { word: "DECEMBER", hint: "åäºŒæœˆ" }]
            }
        };

        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let currentWord = "";
        let currentSpelling = [];
        let currentWordList = [];
        let wordIndex = 0;
        let errorList = [];
        let isReviewMode = false;
        let isGameActive = false; // æ–°å¢ï¼šæ¨™è¨˜éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œä¸­
        let currentGrade = null; 
        let selectedUnits = []; 
        const keys = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        
        // DOM å…ƒç´ 
        const hintDisplay = document.getElementById('hint-display');
        const reviewStatus = document.getElementById('review-status');
        const gradeButtonsContainer = document.getElementById('grade-buttons-container'); 
        const unitButtonsContainer = document.getElementById('unit-buttons-container'); 
        const inputArea = document.getElementById('input-area');
        const startBtn = document.getElementById('start-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const checkBtn = document.getElementById('check-btn');
        const answerBtn = document.getElementById('answer-btn');
        const feedbackMessage = document.getElementById('feedback-message');

        // èªéŸ³åˆæˆç‰©ä»¶
        const synth = window.speechSynthesis;
        let englishVoice = null;

        // --- é¸æ“‡å™¨èˆ‡å–®å­—è¼‰å…¥ ---
        
        function selectGrade(clickedButton) {
            if (isGameActive) return; // éŠæˆ²ä¸­é–å®š
            const grade = clickedButton.dataset.grade;
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
            currentGrade = grade;
            clickedButton.classList.add('selected');
            loadUnits(currentGrade);
        }

        function loadUnits(grade) {
            unitButtonsContainer.innerHTML = '';
            selectedUnits = []; 
            
            if (grade && allWordUnits[grade]) {
                const units = allWordUnits[grade];
                Object.keys(units).forEach(unit => {
                    const button = document.createElement('button');
                    button.className = 'unit-btn';
                    button.textContent = `${unit} (${units[unit].length})`; 
                    button.dataset.unit = unit; 
                    button.onclick = toggleUnitSelection; 
                    unitButtonsContainer.appendChild(button);
                });
            } else {
                 unitButtonsContainer.innerHTML = 'è«‹å…ˆé¸æ“‡å¹´ç´š';
            }
            checkSelectionStatus();
        }

        function toggleUnitSelection() {
            if (isGameActive) return; // éŠæˆ²ä¸­é–å®š
            const unit = this.dataset.unit;
            const index = selectedUnits.indexOf(unit);

            if (index > -1) {
                selectedUnits.splice(index, 1);
                this.classList.remove('selected');
            } else {
                selectedUnits.push(unit);
                this.classList.add('selected');
            }
            checkSelectionStatus();
        }

        function checkSelectionStatus() {
            if (currentGrade && selectedUnits.length > 0) {
                startBtn.disabled = false;
                if (!isGameActive) {
                    startBtn.textContent = 'é–‹å§‹éŠæˆ²';
                }
                hintDisplay.textContent = `å·²é¸æ“‡ ${currentGrade} çš„ ${selectedUnits.length} å€‹å–®å…ƒï¼Œé»æ“Šé–‹å§‹éŠæˆ²ï¼`;
            } else if (currentGrade) {
                startBtn.disabled = true;
                hintDisplay.textContent = 'è«‹é¸æ“‡è¦ç·´ç¿’çš„èª²åˆ¥ï¼';
            } else {
                startBtn.disabled = true;
                hintDisplay.textContent = 'è«‹å…ˆé¸æ“‡å¹´ç´šï¼';
            }
        }
        
        // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

        /**
         * è™•ç†ã€Œé–‹å§‹éŠæˆ²ã€æˆ–ã€Œä¸‹ä¸€å€‹å–®å­—ã€çš„é‚è¼¯
         */
        function handleStartNext() {
            if (!isGameActive) {
                startGameSetup(); // ç¬¬ä¸€æ¬¡é–‹å§‹éŠæˆ²
            } else {
                // éŠæˆ²é€²è¡Œä¸­ï¼šè·³éç•¶å‰å–®å­—ï¼Œé€²å…¥ä¸‹ä¸€é¡Œ
                skipCurrentWord();
            }
        }

        /**
         * è¨­ç½®éŠæˆ²åˆå§‹ç‹€æ…‹ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€æ™‚è§¸ç™¼
         */
        function startGameSetup() {
            if (!currentGrade || selectedUnits.length === 0) {
                hintDisplay.textContent = 'è«‹å…ˆé¸æ“‡å¹´ç´šå’Œèª²åˆ¥ï¼';
                return;
            }
            
            currentWordList = [];
            errorList = [];
            selectedUnits.forEach(unit => {
                currentWordList = currentWordList.concat(allWordUnits[currentGrade][unit]);
            });

            currentWordList.sort(() => Math.random() - 0.5); 
            wordIndex = 0;
            isGameActive = true; 
            
            startBtn.textContent = 'ä¸‹ä¸€å€‹å–®å­—';
            loadNextWord();
        }

        /**
         * è·³éç•¶å‰å–®å­—ï¼Œç›´æ¥è¼‰å…¥ä¸‹ä¸€é¡Œ
         */
        function skipCurrentWord() {
            // å¦‚æœç•¶å‰å–®å­—é‚„æ²’è¢«åŠ å…¥éŒ¯èª¤æ¸…å–® (å³æœªç­”éŒ¯æˆ–çœ‹ç­”æ¡ˆ)ï¼Œå‰‡å°‡å…¶æ¨™è¨˜ç‚ºè·³é
            const currentWordData = currentWordList[wordIndex];
            if (!errorList.find(w => w.word === currentWordData.word)) {
                errorList.push(currentWordData);
                feedbackMessage.textContent = `â­ï¸ å–®å­— ${currentWord} å·²è·³éï¼Œä¸¦åŠ å…¥è¤‡ç¿’æ¸…å–®ã€‚`;
            }
            
            wordIndex++;
            loadNextWord();
        }

        /**
         * è¼‰å…¥ä¸‹ä¸€çµ„å–®å­— (è™•ç†ç©ºæ ¼ä¸¦ç”Ÿæˆè¼¸å…¥æ ¼å­)
         */
        function loadNextWord() {
            if (wordIndex >= currentWordList.length) {
                // æ¸¬é©—çµæŸ
                handleRoundEnd();
                return;
            }
            
            const wordData = currentWordList[wordIndex];
            currentWord = wordData.word;
            currentSpelling = [];
            
            inputArea.innerHTML = '';
            feedbackMessage.textContent = '';
            
            // å•Ÿç”¨éŠæˆ²ä¸­æŒ‰éˆ•
            repeatBtn.disabled = false;
            answerBtn.disabled = false; 
            checkBtn.disabled = true;

            const unitInfo = isReviewMode ? "è¤‡ç¿’é¡Œ" : `ç¬¬ ${wordIndex + 1}/${currentWordList.length} é¡Œ`;
            hintDisplay.textContent = `[${unitInfo}] ${wordData.hint}`;

            const targetChars = currentWord.split(''); 
            
            let letterIndex = 0;
            targetChars.forEach((char, i) => {
                if (char === ' ') {
                    const spaceSlot = document.createElement('div');
                    spaceSlot.className = 'space-slot';
                    inputArea.appendChild(spaceSlot);
                } else {
                    const slot = document.createElement('div');
                    slot.className = 'letter-slot';
                    slot.id = `slot-${letterIndex}`;
                    inputArea.appendChild(slot);
                    letterIndex++;
                }
            });
            
            readWord(currentWord);
        }

        function handleRoundEnd() {
             if (errorList.length > 0) {
                isReviewMode = true;
                setTimeout(() => {
                    const totalErrors = errorList.length;
                    if (confirm(`ğŸ‰ æœ¬è¼ªå®Œæˆï¼æ‚¨æœ‰ ${totalErrors} å€‹å–®å­—éœ€è¦è¤‡ç¿’ã€‚ç¾åœ¨é–‹å§‹è¤‡ç¿’å—ï¼Ÿ`)) {
                        startReviewMode();
                    } else {
                        endGame();
                    }
                }, 500);
            } else {
                endGame();
            }
        }
        
        function startReviewMode() {
            currentWordList = [...errorList];
            wordIndex = 0;
            errorList = [];
            reviewStatus.textContent = `ğŸ”´ éŒ¯èª¤è¤‡ç¿’æ¨¡å¼ï¼šå…± ${currentWordList.length} é¡Œ`;
            loadNextWord();
        }

        function endGame() {
            isReviewMode = false;
            isGameActive = false; // éŠæˆ²çµæŸ
            currentWordList = [];
            wordIndex = 0;
            errorList = [];
            inputArea.innerHTML = '';
            
            // é–å®šæ‰€æœ‰æ§åˆ¶æŒ‰éˆ•ï¼Œåªä¿ç•™ startBtn
            checkBtn.disabled = true;
            answerBtn.disabled = true;
            repeatBtn.disabled = true;
            
            reviewStatus.textContent = '';
            startBtn.textContent = 'é‡æ–°é–‹å§‹';
            
            hintDisplay.textContent = 'ğŸ‘ æ­å–œæ‚¨ï¼æ‰€æœ‰å–®å­—æ¸¬é©—å’Œè¤‡ç¿’éƒ½å·²å®Œæˆï¼';
            feedbackMessage.textContent = 'è«‹é¸æ“‡æ–°çš„å–®å…ƒé–‹å§‹ä¸‹ä¸€è¼ªç·´ç¿’ã€‚';
        }

        // --- èªéŸ³åŠŸèƒ½ (V3.0.1 ä¿®æ­£ä¿æŒä¸è®Š) ---
        
        function setEnglishVoice() {
            if (englishVoice) return;
            const voices = synth.getVoices();
            englishVoice = voices.find(voice => 
                (voice.lang.startsWith('en-US') || voice.lang.startsWith('en-GB')) && 
                voice.name.includes('Female')
            ) || voices.find(voice => voice.lang.startsWith('en'));
        }
        synth.onvoiceschanged = setEnglishVoice;
        
        function speak(text, rate = 0.9, pitch = 1.0) {
            if (synth.speaking) {
                synth.cancel();
            }
            setEnglishVoice();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.voice = englishVoice;
            utterThis.lang = 'en-US'; 
            utterThis.rate = rate; 
            utterThis.pitch = pitch; 
            
            setTimeout(() => {
                synth.speak(utterThis);
            }, 50); 
            
            return utterThis;
        }

        function readWord(word) {
            repeatBtn.disabled = true; 
            const utterThis = speak(word, 0.9, 1.2); 
            utterThis.onend = () => {
                repeatBtn.disabled = false;
            };
        }
        
        // --- è¼¸å…¥èˆ‡æª¢æŸ¥ ---
        
        function handleKeyClick(letter) {
            if (currentWord === "") return;
            
            const pureWord = currentWord.replace(/\s/g, ''); 
            
            if (currentSpelling.length < pureWord.length) {
                currentSpelling.push(letter);
                const currentSlot = document.getElementById(`slot-${currentSpelling.length - 1}`);
                currentSlot.textContent = letter;
            }
            // åªè¦æœ‰è¼¸å…¥ï¼Œå°±å¯ä»¥æª¢æŸ¥ï¼Œä½†å¿…é ˆé•·åº¦å¡«æ»¿
            if (currentSpelling.length === pureWord.length) {
                checkBtn.disabled = false;
            } else {
                checkBtn.disabled = true;
            }
        }
        
        function handleDeleteClick() {
            if (currentSpelling.length > 0) {
                const lastSlotIndex = currentSpelling.length - 1;
                const lastSlot = document.getElementById(`slot-${lastSlotIndex}`);
                if (lastSlot) {
                    lastSlot.textContent = ''; 
                }
                
                currentSpelling.pop(); 
                
                if (currentSpelling.length === 0 || currentSpelling.length < currentWord.replace(/\s/g, '').length) {
                    checkBtn.disabled = true;
                }
            }
        }

        /**
         * æª¢æŸ¥æ‹¼å¯« (æµç¨‹å„ªåŒ– V3.0.3)
         */
        function checkSpelling() {
            checkBtn.disabled = true;
            repeatBtn.disabled = true;
            answerBtn.disabled = true; // æª¢æŸ¥å¾Œé–å®šçœ‹ç­”æ¡ˆ

            const playerWord = currentSpelling.join('');
            const pureWord = currentWord.replace(/\s/g, ''); 

            if (playerWord === pureWord) {
                // ç­”å°æµç¨‹
                feedbackMessage.textContent = 'ğŸ­ å¤ªæ£’äº†ï¼æ‹¼å¯«å®Œå…¨æ­£ç¢ºï¼'; 
                
                // å”¸æ­£ç¢ºç­”æ¡ˆ
                const utterThis = speak('Excellent! The word is ' + currentWord, 1.0, 1.0);
                
                for (let i = 0; i < pureWord.length; i++) {
                    document.getElementById(`slot-${i}`).classList.add('correct');
                }

                // ä¿®æ­£ï¼šç­”å°å¾Œç­‰å¾… 1.5 ç§’ï¼Œä½† **ä¸è‡ªå‹•è·³è½‰**
                utterThis.onend = () => {
                    setTimeout(() => {
                        feedbackMessage.textContent += ' (è«‹é»æ“Šã€Œä¸‹ä¸€å€‹å–®å­—ã€ç¹¼çºŒ)';
                        startBtn.textContent = 'ä¸‹ä¸€å€‹å–®å­—';
                        startBtn.disabled = false; // å•Ÿç”¨è·³è½‰æŒ‰éˆ•
                        wordIndex++; // ç´¢å¼•å·²å¢åŠ ï¼Œç­‰å¾… loadNextWord
                    }, 1500); 
                };
                
            } else {
                // ç­”éŒ¯æµç¨‹
                feedbackMessage.textContent = 'ğŸ’¡ éŒ¯å›‰ï¼å³å°‡é‡å”¸ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼';
                
                for (let i = 0; i < pureWord.length; i++) {
                    const slot = document.getElementById(`slot-${i}`);
                    if (currentSpelling[i] && currentSpelling[i] === pureWord[i]) {
                        slot.classList.add('correct');
                    } else {
                        slot.classList.add('incorrect');
                    }
                }
                
                // å°‡éŒ¯çš„å–®å­—åŠ å…¥è¤‡ç¿’æ¸…å–®
                const currentWordData = currentWordList[wordIndex];
                if (!errorList.find(w => w.word === currentWordData.word)) {
                    errorList.push(currentWordData);
                }
                
                resetForRetry(); 
                answerBtn.disabled = false; // ç­”éŒ¯å¾Œä»å¯çœ‹ç­”æ¡ˆ
                
                // 1.5 ç§’å¾Œè‡ªå‹•é‡å”¸å–®å­—
                setTimeout(() => readWord(currentWord), 1500); 
            }
        }
        
        function resetForRetry() {
            feedbackMessage.textContent = 'è«‹å†è©¦ä¸€æ¬¡ï¼é»æ“Šå­—æ¯é‡æ–°è¼¸å…¥ã€‚';
            currentSpelling = [];
            
            const pureWord = currentWord.replace(/\s/g, '');
            
            for (let i = 0; i < pureWord.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) {
                    slot.textContent = '';
                    slot.classList.remove('correct', 'incorrect', 'skipped');
                }
            }
            repeatBtn.disabled = false;
        }

        /**
         * é¡¯ç¤ºç­”æ¡ˆ (æµç¨‹å„ªåŒ– V3.0.3)
         */
        function showAnswer() {
            checkBtn.disabled = true;
            repeatBtn.disabled = true;
            answerBtn.disabled = true; 

            const word = currentWord;
            const pureWord = word.replace(/\s/g, '');
            
            for (let i = 0; i < pureWord.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (slot) {
                    slot.textContent = pureWord[i];
                    slot.classList.add('skipped');
                }
            }
            
            feedbackMessage.textContent = `ç­”æ¡ˆæ˜¯ ${word}ã€‚å·²åŠ å…¥å¾…è¤‡ç¿’æ¸…å–®ï¼`;
            
            // èªéŸ³å ±è®€ç­”æ¡ˆ
            const utterThis = speak(`The correct word is ${word}`);

            // å°‡çœ‹ç­”æ¡ˆçš„å–®å­—åŠ å…¥è¤‡ç¿’æ¸…å–®
            const currentWordData = currentWordList[wordIndex];
            if (!errorList.find(w => w.word === currentWordData.word)) {
                 errorList.push(currentWordData);
            }

            // ä¿®æ­£ï¼šçœ‹ç­”æ¡ˆå¾Œç­‰å¾… 1.5 ç§’ï¼Œä½† **ä¸è‡ªå‹•è·³è½‰**
            utterThis.onend = () => {
                setTimeout(() => {
                    feedbackMessage.textContent += ' (è«‹é»æ“Šã€Œä¸‹ä¸€å€‹å–®å­—ã€ç¹¼çºŒ)';
                    startBtn.textContent = 'ä¸‹ä¸€å€‹å–®å­—';
                    startBtn.disabled = false; // å•Ÿç”¨è·³è½‰æŒ‰éˆ•
                    wordIndex++; // ç´¢å¼•å·²å¢åŠ ï¼Œç­‰å¾… loadNextWord
                }, 1500); 
            };
        }


        // --- åˆå§‹åŒ– ---
        function createKeyboard() {
            const keyboardDiv = document.getElementById('keyboard');
            
            keys.forEach(letter => {
                const keyBtn = document.createElement('button');
                keyBtn.className = 'key';
                keyBtn.textContent = letter;
                keyBtn.onclick = () => handleKeyClick(letter);
                keyboardDiv.appendChild(keyBtn);
            });
            
            // æ–°å¢ DELETE éµ
            const deleteKey = document.createElement('button');
            deleteKey.id = 'delete-key';
            deleteKey.className = 'key';
            deleteKey.textContent = 'DEL';
            deleteKey.onclick = handleDeleteClick;
            keyboardDiv.appendChild(deleteKey);
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            createKeyboard();
            checkSelectionStatus(); 
        };
        
        // å°‡ startBtn çš„é»æ“Šäº‹ä»¶å°å‘æ–°çš„è™•ç†å‡½æ•¸
        // startBtn.onclick = handleStartNext; 
        repeatBtn.onclick = () => readWord(currentWord); 
        checkBtn.onclick = checkSpelling;
        
    </script>

</body>
</html>
