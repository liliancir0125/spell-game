<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>è‹±æ–‡è½å¯«ç·´ç¿’æ©Ÿ (V3.2.0)</title>
    <style>
        /* ------------------- CSS æ¨£å¼ ------------------- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f7f7; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; /* èª¿æ•´ç‚º0ï¼Œç”± container æ§åˆ¶ */
            color: #333;
            margin: 0;
        }

        /* æ–°å¢ï¼šå›å¤§å»³å°è¦½åˆ—æ¨£å¼ */
        .nav-header {
            width: 100%;
            background: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            border-bottom: 3px solid #a4e2ff;
            box-sizing: border-box;
        }

        .btn-home {
            text-decoration: none;
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #4a90e2;
            color: #4a90e2;
            transition: all 0.2s;
        }

        .btn-home:hover {
            background: #4a90e2;
            color: white;
        }
        
        /* é˜²æ­¢è¡Œå‹•è£ç½®è¼¸å…¥æ™‚è‡ªå‹•ç¸®æ”¾ */
        body, .key, .letter-slot {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        #game-container {
            width: 95%; 
            max-width: 900px; 
            border: 5px solid #a4e2ff; 
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            margin-top: 20px;
        }

        h2 { color: #4a90e2; margin-top: 10px; }

        /* ------------------- é¸æ“‡ä»‹é¢ ------------------- */
        #selection-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #grade-buttons-container {
            display: flex;
            justify-content: center;
            gap: 30px; 
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        #unit-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; 
            margin-bottom: 15px;
            min-height: 50px;
        }

        .unit-btn {
            padding: 8px 15px;
            font-size: 16px;
            border: 2px solid #ffb3c1; 
            border-radius: 8px;
            cursor: pointer;
            background-color: #f0f0f0;
            transition: all 0.1s;
        }
        
        .grade-btn { 
            padding: 10px 25px;
            font-size: 18px;
            font-weight: bold;
        }

        .unit-btn.selected {
            background-color: #4a90e2; 
            color: white;
            border-color: #4a90e2;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #review-status {
            font-size: 18px;
            color: #d9534f;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        #hint-display {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 20px;
            min-height: 30px;
        }

        /* ------------------- è¼¸å…¥å€ ------------------- */
        #input-area {
            display: flex;
            justify-content: center;
            gap: 10px; 
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .letter-slot {
            width: 50px; 
            height: 60px; 
            line-height: 60px;
            font-size: 34px; 
            font-weight: bold;
            border: 3px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
        }

        .space-slot {
            width: 25px; 
            height: 60px;
            background-color: transparent;
            border: none;
        }

        /* ------------------- éµç›¤èˆ‡æ§åˆ¶æŒ‰éˆ• ------------------- */
        #keyboard {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px; 
            margin-top: 20px;
        }

        .key {
            background-color: #a4e2ff; 
            color: #333; 
            border: none;
            padding: 15px 0; 
            font-size: 24px; 
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .key:active { background-color: #79c5f0; }
        
        #delete-key { background-color: #777; color: white; font-size: 20px; }
        #delete-key:active { background-color: #555; }

        #control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px; 
            margin-top: 30px;
        }

        .control-btn {
            padding: 15px 30px; 
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px #999;
            transition: all 0.1s;
        }

        .control-btn:active {
            box-shadow: 0 0 #999;
            transform: translateY(4px);
        }

        #repeat-btn { background-color: #5cb85c; color: white; }
        #check-btn { background-color: #f0ad4e; color: white; }
        #answer-btn { background-color: #5bc0de; color: white; }
        
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }

        .correct { background-color: #aaffaa !important; border-color: #4CAF50 !important; }
        .incorrect { background-color: #ffaaaa !important; border-color: #f44336 !important; }
        .skipped { background-color: #ffe4b2 !important; border-color: #ff8c00 !important; }

        #feedback-message {
            font-size: 24px; 
            font-weight: bold;
            min-height: 35px;
            margin-top: 15px;
            color: #4a90e2;
        }

        /* ç‰ˆæœ¬è™Ÿæ¨£å¼ */
        .version-info {
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="https://liliancir0125.github.io/Rumi_Study_Hall/" class="btn-home">ğŸ  å›å¤§å»³</a>
    </div>

    <div id="game-container">
        <h2>â˜ï¸ è‹±æ–‡è½å¯«ç·´ç¿’æ©Ÿ</h2>
        <div id="review-status"></div>

        <div id="selection-controls">
            <div id="grade-buttons-container">
                <button class="grade-btn unit-btn" data-grade="G1" onclick="selectGrade(this)">G1</button>
                <button class="grade-btn unit-btn" data-grade="G2" onclick="selectGrade(this)">G2</button>
            </div>
            <div id="unit-buttons-container">è«‹å…ˆé¸æ“‡å¹´ç´š</div>
        </div>

        <div id="hint-display">è«‹å…ˆé¸æ“‡å¹´ç´šå’Œå–®å…ƒæŒ‰éˆ•ï¼Œç„¶å¾Œé»æ“Šé–‹å§‹ï¼</div>
        <div id="input-area"></div>

        <div id="control-buttons">
            <button id="start-btn" class="control-btn" onclick="handleStartNext()" disabled>é–‹å§‹éŠæˆ²</button> 
            <button id="repeat-btn" class="control-btn" disabled>ğŸ”ˆ é‡è¤‡å”¸ä¸€æ¬¡</button>
            <button id="check-btn" class="control-btn" disabled>âœ… æª¢æŸ¥æ‹¼å¯«</button>
            <button id="answer-btn" class="control-btn" onclick="showAnswer()" disabled>ğŸ“– çœ‹è§£ç­”</button>
        </div>

        <div id="feedback-message"></div>
        <div id="keyboard"></div>
        
        <div class="version-info">Ver. 3.2.0 (Based on 3.1.2)</div>
    </div>

    <script>
        // å–®å­—åº«éƒ¨åˆ†å·²å®Œæ•´ä¿ç•™è‡ªä½ çš„ 3.1.2 ç©©å®šç‰ˆå…§å®¹ (ç•¥ï¼Œä¿æŒåŸå§‹ç¢¼ä¸€è‡´)
        const allWordUnits = {
            "G1": {
                "U1": [{ word: "HE IS", hint: "ä»–æ˜¯" }, { word: "I AM", hint: "æˆ‘æ˜¯" }, { word: "NAME", hint: "åå­—" }, { word: "SHE IS", hint: "å¥¹æ˜¯" }, { word: "THE", hint: "é€™å€‹" }, { word: "THIS", hint: "é€™å€‹" }, { word: "YOU ARE", hint: "ä½ æ˜¯" }, { word: "WHAT", hint: "ä»€éº¼" }],
                "U2": [{ word: "THAT", hint: "é‚£å€‹" }, { word: "AND", hint: "å’Œ" }, { word: "OUR", hint: "æˆ‘å€‘çš„" }, { word: "HER", hint: "å¥¹çš„" }, { word: "HIS", hint: "ä»–çš„" }, { word: "MY", hint: "æˆ‘çš„" }, { word: "OPEN", hint: "æ‰“é–‹" }, { word: "YOUR", hint: "ä½ çš„" }, { word: "THEY", hint: "ä»–å€‘" }, { word: "CLOSE", hint: "é—œä¸Š" }, { word: "WE", hint: "æˆ‘å€‘" }, { word: "THEIR", hint: "ä»–å€‘çš„" }],
                "U3": [{ word: "SCHOOL", hint: "å­¸æ ¡" }, { word: "GOOD", hint: "å¥½çš„" }, { word: "FIRST GRADE", hint: "ä¸€å¹´ç´š" }, { word: "HELLO", hint: "å“ˆå›‰" }, { word: "IN", hint: "åœ¨" }, { word: "NO", hint: "ä¸" }, { word: "NOT", hint: "ä¸" }, { word: "TOO", hint: "ä¹Ÿæ˜¯" }, { word: "WHO", hint: "èª°" }, { word: "YES", hint: "æ˜¯" }],
                "U4": [{ word: "WHITE", hint: "ç™½è‰²" }, { word: "ORANGE", hint: "æ©˜è‰²" }, { word: "BLACK", hint: "é»‘è‰²" }, { word: "GREEN", hint: "ç¶ è‰²" }, { word: "YELLOW", hint: "é»ƒè‰²" }, { word: "BLUE", hint: "è—è‰²" }, { word: "COLOR", hint: "é¡è‰²" }, { word: "PINK", hint: "ç²‰ç´…è‰²" }, { word: "RED", hint: "ç´…è‰²" }, { word: "WHOSE", hint: "èª°çš„" }],
                "U5": [{ word: "WHERE", hint: "å“ªè£¡" }, { word: "GROUP", hint: "çµ„" }, { word: "THERE IS", hint: "æœ‰ (å–®æ•¸)" }, { word: "CLASSROOM", hint: "æ•™å®¤" }, { word: "IT", hint: "å®ƒ" }, { word: "THERE ARE", hint: "æœ‰ (è¤‡æ•¸)" }, { word: "TELL", hint: "å‘Šè¨´" }, { word: "AT", hint: "åœ¨æ–¼" }, { word: "GO", hint: "å»" }, { word: "ON", hint: "åœ¨...ä¸Šé¢" }],
                "U6": [{ word: "DRAW", hint: "ç•«ç•«" }, { word: "READ", hint: "é–±è®€" }, { word: "COUNT", hint: "æ•¸æ•¸" }, { word: "WRITE", hint: "å¯«" }, { word: "CAN", hint: "å¯ä»¥" }, { word: "CANT", hint: "ä¸å¯ä»¥" }, { word: "CANNOT", hint: "ä¸å¯ä»¥" }, { word: "EAT", hint: "åƒ" }, { word: "RUN", hint: "è·‘" }, { word: "SLEEP", hint: "ç¡è¦º" }],
                "U7": [{ word: "THESE", hint: "é€™äº›" }, { word: "THOSE", hint: "é‚£äº›" }, { word: "COME TO", hint: "ä¾†" }, { word: "TWO", hint: "äºŒ" }, { word: "WALK TO", hint: "èµ°åˆ°" }, { word: "BY BUS", hint: "æ­å…¬è»Š" }, { word: "FOUR", hint: "å››" }, { word: "HOW", hint: "å¦‚ä½•" }, { word: "ONE", hint: "ä¸€" }, { word: "THREE", hint: "ä¸‰" }],
                "U8": [{ word: "DOES", hint: "åš" }, { word: "HOMEWORK", hint: "å®¶åº­ä½œæ¥­" }, { word: "DOESNT", hint: "ä¸ (doesn't)" }, { word: "KNOW", hint: "çŸ¥é“" }, { word: "WITH", hint: "å’Œ" }, { word: "DONT", hint: "ä¸ (don't)" }, { word: "KICK", hint: "è¸¢" }, { word: "LETS", hint: "è®“æˆ‘å€‘" }, { word: "WANT TO", hint: "æƒ³è¦" }, { word: "JUMP", hint: "è·³" }, { word: "DO", hint: "åš" }, { word: "PLAY", hint: "ç©" }],
                "U9": [{ word: "EIGHT", hint: "å…«" }, { word: "ELEVEN", hint: "åä¸€" }, { word: "WHAT TIME", hint: "å¹¾é»é˜" }, { word: "TWELVE", hint: "åäºŒ" }, { word: "FIVE", hint: "äº”" }, { word: "FOR", hint: "çµ¦" }, { word: "NINE", hint: "ä¹" }, { word: "SEVEN", hint: "ä¸ƒ" }, { word: "SIX", hint: "å…­" }, { word: "TEN", hint: "å" }],
                "U10": [{ word: "WINDY", hint: "é¢¨å¤§çš„" }, { word: "DRY", hint: "ä¹¾çš„" }, { word: "WARM", hint: "æº«æš–çš„" }, { word: "RAINY", hint: "ä¸‹é›¨çš„" }, { word: "COLD", hint: "å¯’å†·çš„" }, { word: "HOT", hint: "ç‚ç†±çš„" }, { word: "OR", hint: "æˆ–è€…" }, { word: "SUNNY", hint: "æ™´æœ—çš„" }, { word: "TODAY", hint: "ä»Šå¤©" }, { word: "WET", hint: "æ½®æ¿•çš„" }]
            },
            "G2": {
                "U1": [{ word: "FINGER", hint: "æ‰‹æŒ‡é ­" }, { word: "THUMB", hint: "å¤§æ‹‡æŒ‡" }, { word: "BODY", hint: "èº«é«”" }, { word: "TOE", hint: "è…³è¶¾" }, { word: "LEG", hint: "è…¿" }, { word: "BACK", hint: "èƒŒ" }, { word: "ARM", hint: "æ‰‹è‡‚" }, { word: "HAND", hint: "æ‰‹" }, { word: "FOOT", hint: "è…³ (å–®æ•¸)" }, { word: "FEET", hint: "è…³ (è¤‡æ•¸)" }, { word: "HAVE", hint: "æœ‰(I/You/We)" }, { word: "HAS", hint: "æœ‰(She/He/It)" }],
                "U2": [{ word: "EYE", hint: "çœ¼ç›" }, { word: "EAR", hint: "è€³æœµ" }, { word: "HAIR", hint: "é ­é«®" }, { word: "MOUTH", hint: "å˜´å·´" }, { word: "NOSE", hint: "é¼»å­" }, { word: "BIG", hint: "å¤§çš„" }, { word: "LITTLE", hint: "å°çš„" }, { word: "SHORT", hint: "çŸ­çš„" }, { word: "LONG", hint: "é•·çš„" }, { word: "NOW", hint: "ç¾åœ¨" }],
                "U3": [{ word: "COAT", hint: "å¤–å¥—" }, { word: "SHIRT", hint: "è¥¯è¡«" }, { word: "PANTS", hint: "è¤²å­" }, { word: "SHORTS", hint: "çŸ­è¤²" }, { word: "SKIRT", hint: "è£™å­" }, { word: "SOCKS", hint: "è¥ªå­" }, { word: "SHOES", hint: "é‹å­" }, { word: "DRESS", hint: "æ´‹è£" }, { word: "SWEATER", hint: "æ¯›è¡£" }, { word: "GLASSES", hint: "çœ¼é¡" }],
                "U4": [{ word: "TIRED", hint: "ç–²å€¦çš„" }, { word: "HAPPY", hint: "å¿«æ¨‚çš„" }, { word: "SAD", hint: "æ‚²å‚·çš„" }, { word: "BORED", hint: "ç„¡èŠçš„" }, { word: "ANGRY", hint: "ç”Ÿæ°£çš„" }, { word: "CRAZY", hint: "ç˜‹ç‹‚çš„" }, { word: "HUNGRY", hint: "è‚šå­é¤“çš„" }, { word: "THIRSTY", hint: "å£æ¸´çš„" }, { word: "SICK", hint: "ç”Ÿç—…çš„" }, { word: "SCARED", hint: "å®³æ€•çš„" }],
                "U5": [{ word: "DECEMBER", hint: "åäºŒæœˆ" }, { word: "MONTH", hint: "æœˆ" }, { word: "JANUARY", hint: "ä¸€æœˆ" }, { word: "FEBRUARY", hint: "äºŒæœˆ" }, { word: "MARCH", hint: "ä¸‰æœˆ" }, { word: "APRIL", hint: "å››æœˆ" }, { word: "MAY", hint: "äº”æœˆ" }, { word: "JUNE", hint: "å…­æœˆ" }, { word: "JULY", hint: "ä¸ƒæœˆ" }, { word: "AUGUST", hint: "å…«æœˆ" }, { word: "SEPTEMBER", hint: "ä¹æœˆ" }, { word: "OCTOBER", hint: "åæœˆ" }, { word: "NOVEMBER", hint: "åä¸€æœˆ" }],
                "U6": [{ word: "BIRTHDAY", hint: "ç”Ÿæ—¥" }, { word: "GIFT", hint: "ç¦®ç‰©" }, { word: "THANKS", hint: "è¬è¬" }, { word: "FROM", hint: "å¾.../ä¾†è‡ª" }, { word: "US", hint: "æˆ‘å€‘ (å—æ ¼)" }, { word: "COMPUTER", hint: "é›»è…¦" }, { word: "GAME", hint: "éŠæˆ²" }, { word: "ME", hint: "æˆ‘ (å—æ ¼)" }, { word: "YOU", hint: "ä½ (å—æ ¼)" }, { word: "HIM", hint: "ä»– (å—æ ¼)" }, { word: "THEM", hint: "ä»–å€‘ (å—æ ¼)" }, { word: "TALK", hint: "èªªè©±" }, { word: "SING", hint: "å”±æ­Œ" }, { word: "SONG", hint: "æ­Œæ›²" }, { word: "STORY", hint: "æ•…äº‹" }],
                "U7": [{ word: "FAMILY", hint: "å®¶åº­" }, { word: "BROTHER", hint: "å…„å¼Ÿæˆ–å¼Ÿ" }, { word: "SISTER", hint: "å§Šå§Šæˆ–å¦¹" }, { word: "PEOPLE", hint: "äººå€‘(ç•¶è¤‡æ•¸ç”¨)" }, { word: "FATHER", hint: "çˆ¶è¦ª" }, { word: "AUNT", hint: "å§‘å§‘æˆ–é˜¿å§¨" }, { word: "MOTHER", hint: "æ¯è¦ª" }, { word: "UNCLE", hint: "ä¼¯çˆ¶æˆ–å”å”" }, { word: "COUSIN", hint: "å ‚(è¡¨)å…„ã€å¼Ÿã€å§Šã€å¦¹" }, { word: "GRANDFATHER", hint: "ç¥–çˆ¶" }, { word: "GRANDMOTHER", hint: "ç¥–æ¯" }, { word: "MANY", hint: "å¾ˆå¤šçš„" }, { word: "BECAUSE", hint: "å› ç‚º" }],
                "U8": [{ word: "AFRAID", hint: "å®³æ€•çš„" }, { word: "PET", hint: "å¯µç‰©" }, { word: "DOG", hint: "ç‹—" }, { word: "BUT", hint: "ä½†æ˜¯" }, { word: "LIKE/LIKES", hint: "å–œæ­¡" }, { word: "CAT", hint: "è²“" }, { word: "ANIMAL", hint: "å‹•ç‰©" }, { word: "HAMSTER", hint: "å€‰é¼ " }, { word: "TURTLE", hint: "çƒé¾œ" }, { word: "SNAKE", hint: "è›‡" }, { word: "FISH", hint: "é­š" }, { word: "BIRD", hint: "é³¥" }, { word: "LIZARD", hint: "èœ¥èœ´" }],
                "U9": [{ word: "KITCHEN", hint: "å»šæˆ¿" }, { word: "DOING", hint: "åš" }, { word: "BEDROOM", hint: "è‡¥å®¤" }, { word: "BATHROOM", hint: "æµ´å®¤" }, { word: "DINING ROOM", hint: "é£¯å»³" }, { word: "STUDY", hint: "æ›¸æˆ¿" }, { word: "LIVING ROOM", hint: "å®¢å»³" }, { word: "READING", hint: "é–±è®€" }, { word: "COOKING", hint: "ç…®é£¯" }, { word: "WATCHING", hint: "çœ‹" }, { word: "TV", hint: "é›»è¦–" }, { word: "SLEEPING", hint: "ç¡è¦º" }, { word: "EATING", hint: "åƒ" }, { word: "WASHING", hint: "æ´—" }, { word: "WRITING", hint: "å¯«" }],
                "U10": [{ word: "DESK", hint: "æ›¸æ¡Œ" }, { word: "UNDER", hint: "åœ¨...ä¸‹é¢" }, { word: "BED", hint: "åºŠ" }, { word: "TABLE", hint: "æ¡Œå­" }, { word: "CLOSET", hint: "è¡£æ«¥" }, { word: "BATHTUB", hint: "æµ´ç¼¸" }, { word: "SINK", hint: "æ°´æ§½" }, { word: "CHAIR", hint: "æ¤…å­" }, { word: "REFRIGERATOR", hint: "å†°ç®±" }, { word: "STOVE", hint: "ç«çˆ" }, { word: "SOFA", hint: "æ²™ç™¼" }, { word: "BESIDE", hint: "åœ¨...æ—é‚Š" }, { word: "PUT", hint: "æ”¾" }]
            }
        };

        let currentWord = "", currentSpelling = [], currentWordList = [], wordIndex = 0, errorList = [], isReviewMode = false, isGameActive = false, currentGrade = null, selectedUnits = [];
        const synth = window.speechSynthesis;
        let englishVoice = null;

        const hintDisplay = document.getElementById('hint-display');
        const reviewStatus = document.getElementById('review-status');
        const unitButtonsContainer = document.getElementById('unit-buttons-container');
        const inputArea = document.getElementById('input-area');
        const startBtn = document.getElementById('start-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const checkBtn = document.getElementById('check-btn');
        const answerBtn = document.getElementById('answer-btn');
        const feedbackMessage = document.getElementById('feedback-message');

        function selectGrade(clickedButton) {
            const grade = clickedButton.dataset.grade;
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('selected'));
            currentGrade = grade;
            clickedButton.classList.add('selected');
            loadUnits(currentGrade);
        }

        function loadUnits(grade) {
            unitButtonsContainer.innerHTML = '';
            if (!isGameActive) selectedUnits = [];
            if (grade && allWordUnits[grade]) {
                Object.keys(allWordUnits[grade]).forEach(unit => {
                    const button = document.createElement('button');
                    button.className = 'unit-btn' + (selectedUnits.includes(unit) ? ' selected' : '');
                    button.textContent = `${unit} (${allWordUnits[grade][unit].length})`;
                    button.dataset.unit = unit;
                    if (isGameActive) button.disabled = true;
                    else button.onclick = toggleUnitSelection;
                    unitButtonsContainer.appendChild(button);
                });
            } else { unitButtonsContainer.innerHTML = 'è«‹å…ˆé¸æ“‡å¹´ç´š'; }
            checkSelectionStatus();
        }

        function toggleUnitSelection() {
            const unit = this.dataset.unit;
            const idx = selectedUnits.indexOf(unit);
            if (idx > -1) { selectedUnits.splice(idx, 1); this.classList.remove('selected'); }
            else { selectedUnits.push(unit); this.classList.add('selected'); }
            checkSelectionStatus();
        }

        function checkSelectionStatus() {
            if (currentGrade && selectedUnits.length > 0) {
                startBtn.disabled = false;
                hintDisplay.textContent = `å·²é¸æ“‡ ${currentGrade} çš„ ${selectedUnits.length} å€‹å–®å…ƒï¼Œé»æ“Šé–‹å§‹éŠæˆ²ï¼`;
            } else {
                startBtn.disabled = true;
                hintDisplay.textContent = currentGrade ? 'è«‹é¸æ“‡è¦ç·´ç¿’çš„èª²åˆ¥ï¼' : 'è«‹å…ˆé¸æ“‡å¹´ç´šï¼';
            }
        }

        function handleStartNext() {
            if (!isGameActive) startGameSetup();
            else if (startBtn.textContent === 'ä¸‹ä¸€å€‹å–®å­—') {
                if (wordIndex < currentWordList.length) skipCurrentWord();
                else loadNextWord();
            }
        }

        function startGameSetup() {
            currentWordList = [];
            errorList = [];
            selectedUnits.forEach(u => currentWordList = currentWordList.concat(allWordUnits[currentGrade][u]));
            currentWordList.sort(() => Math.random() - 0.5);
            wordIndex = 0;
            isGameActive = true;
            document.querySelectorAll('.unit-btn').forEach(b => b.disabled = true);
            startBtn.textContent = 'ä¸‹ä¸€å€‹å–®å­—';
            loadNextWord();
        }

        function loadNextWord() {
            if (wordIndex >= currentWordList.length) { handleRoundEnd(); return; }
            const data = currentWordList[wordIndex];
            currentWord = data.word;
            currentSpelling = [];
            inputArea.innerHTML = '';
            feedbackMessage.textContent = '';
            repeatBtn.disabled = false;
            answerBtn.disabled = false;
            checkBtn.disabled = true;
            hintDisplay.textContent = `[${isReviewMode ? "è¤‡ç¿’" : "ç¬¬ "+(wordIndex+1)+"/"+currentWordList.length+" é¡Œ"}] ${data.hint}`;
            
            let letterIdx = 0;
            currentWord.split('').forEach(char => {
                if (char === ' ') {
                    const s = document.createElement('div'); s.className = 'space-slot'; inputArea.appendChild(s);
                } else {
                    const slot = document.createElement('div'); slot.className = 'letter-slot'; slot.id = `slot-${letterIdx++}`; inputArea.appendChild(slot);
                }
            });
            readWord(currentWord);
            checkBtn.textContent = 'âœ… æª¢æŸ¥æ‹¼å¯«';
            checkBtn.onclick = checkSpelling;
        }

        function skipCurrentWord() {
            const data = currentWordList[wordIndex];
            if (!errorList.find(w => w.word === data.word)) errorList.push(data);
            wordIndex++; loadNextWord();
        }

        function handleRoundEnd() {
            if (errorList.length > 0) {
                isReviewMode = true;
                setTimeout(() => { if (confirm(`ğŸ‰ æœ¬è¼ªå®Œæˆï¼æœ‰ ${errorList.length} å€‹å–®å­—éœ€è¤‡ç¿’ã€‚ç¾åœ¨é–‹å§‹å—ï¼Ÿ`)) startReviewMode(); else endGame(); }, 500);
            } else endGame();
        }

        function startReviewMode() {
            currentWordList = [...errorList]; wordIndex = 0; errorList = [];
            reviewStatus.textContent = `ğŸ”´ éŒ¯èª¤è¤‡ç¿’æ¨¡å¼ï¼šå…± ${currentWordList.length} é¡Œ`; loadNextWord();
        }

        function endGame() {
            isReviewMode = isGameActive = false; wordIndex = 0; errorList = [];
            inputArea.innerHTML = ''; reviewStatus.textContent = '';
            document.querySelectorAll('.unit-btn').forEach(b => b.disabled = false);
            startBtn.textContent = 'é‡æ–°é–‹å§‹';
            hintDisplay.textContent = 'ğŸ‘ æ­å–œæ‚¨ï¼æ¸¬é©—å·²å®Œæˆï¼';
        }

        function speak(text, rate = 0.9, pitch = 1.0) {
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US'; utter.rate = rate; utter.pitch = pitch;
            synth.speak(utter);
            return utter;
        }

        function readWord(word) {
            repeatBtn.disabled = true;
            const u = speak(word, 0.9, 1.2);
            u.onend = () => repeatBtn.disabled = false;
        }

        function createKeyboard() {
            const kbd = document.getElementById('keyboard');
            kbd.innerHTML = '';
            "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l => {
                const b = document.createElement('button'); b.className = 'key'; b.textContent = l;
                b.onclick = () => handleKeyClick(l); kbd.appendChild(b);
            });
            const del = document.createElement('button'); del.className = 'key'; del.id = 'delete-key'; del.textContent = 'â†';
            del.onclick = handleDeleteClick; kbd.appendChild(del);
        }

        function handleKeyClick(l) {
            if (!currentWord) return;
            const pure = currentWord.replace(/\s/g, '');
            if (currentSpelling.length < pure.length) {
                currentSpelling.push(l);
                const slot = document.getElementById(`slot-${currentSpelling.length - 1}`);
                slot.textContent = l;
                checkBtn.disabled = (currentSpelling.length !== pure.length);
            }
        }

        function handleDeleteClick() {
            if (currentSpelling.length > 0) {
                const slot = document.getElementById(`slot-${currentSpelling.length - 1}`);
                slot.textContent = ''; slot.className = 'letter-slot';
                currentSpelling.pop();
                checkBtn.disabled = true;
            }
        }

        function checkSpelling() {
            const pure = currentWord.replace(/\s/g, '').toUpperCase();
            const input = currentSpelling.join('').toUpperCase();
            const isCorrect = (input === pure);
            
            for (let i = 0; i < pure.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                slot.classList.add(input[i] === pure[i] ? 'correct' : 'incorrect');
            }

            if (isCorrect) {
                feedbackMessage.textContent = "â­ å¤ªæ£’äº†ï¼æ‹¼å°äº†ï¼";
                speak("Excellent!");
                setTimeout(() => { wordIndex++; loadNextWord(); }, 1200);
            } else {
                feedbackMessage.textContent = "âŒ æ‹¼éŒ¯äº†ï¼Œå†è©¦è©¦çœ‹æˆ–çœ‹è§£ç­”ã€‚";
                speak("Try again.");
                if (!errorList.find(w => w.word === currentWord)) errorList.push(currentWordList[wordIndex]);
            }
        }

        function showAnswer() {
            const pure = currentWord.replace(/\s/g, '').toUpperCase();
            for (let i = 0; i < pure.length; i++) {
                const slot = document.getElementById(`slot-${i}`);
                slot.textContent = pure[i];
                slot.className = 'letter-slot skipped';
            }
            feedbackMessage.textContent = `ğŸ’¡ æ­£ç¢ºè§£ç­”æ˜¯ï¼š${currentWord}`;
            if (!errorList.find(w => w.word === currentWord)) errorList.push(currentWordList[wordIndex]);
            checkBtn.disabled = true;
        }

        document.getElementById('repeat-btn').onclick = () => readWord(currentWord);
        window.onload = createKeyboard;
    </script>
</body>
</html>
